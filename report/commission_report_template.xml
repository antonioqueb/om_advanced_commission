<odoo>
    <!-- 1. Definición de la Acción de Reporte -->
    <record id="action_report_commission_pdf" model="ir.actions.report">
        <field name="name">Reporte Detallado de Comisiones</field>
        <field name="model">commission.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">om_advanced_commission.report_commission_document</field>
        <field name="report_file">om_advanced_commission.report_commission_document</field>
        <field name="print_report_name">'Comisiones %s - %s' % (object.date_from, object.date_to)</field>
        <field name="binding_model_id" ref="model_commission_report_wizard"/>
        <field name="binding_type">report</field>
    </record>

    <!-- 2. Plantilla QWeb -->
    <template id="report_commission_document">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="text-center mb-4">
                        <h2>Reporte de Comisiones</h2>
                        <p>
                            <strong>Desde:</strong> <span t-esc="data['date_from']" t-options='{"widget": "date"}'/>
                            <span class="mx-2">-</span>
                            <strong>Hasta:</strong> <span t-esc="data['date_to']" t-options='{"widget": "date"}'/>
                        </p>
                    </div>

                    <!-- Iterar sobre cada Vendedor -->
                    <t t-foreach="docs" t-as="group">
                        <div class="mt-4 mb-2 p-2 bg-light border">
                            <h4 class="m-0 text-primary">
                                <span t-field="group['partner'].name"/>
                            </h4>
                        </div>

                        <table class="table table-sm table-striped table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Ref. Factura</th>
                                    <th>Origen Venta</th>
                                    <th>Pago Relacionado</th>
                                    <th class="text-right">Base Cobrada</th>
                                    <th class="text-center">% Calc.</th>
                                    <th class="text-right">Comisión</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="group['moves']" t-as="move">
                                    <td><span t-field="move.date"/></td>
                                    <td>
                                        <!-- Obtenemos el nombre de la factura desde la línea contable -->
                                        <span t-if="move.invoice_line_id" t-field="move.invoice_line_id.move_id.name"/>
                                        <span t-else="">-</span>
                                    </td>
                                    <td><span t-field="move.sale_order_id.name"/></td>
                                    <td>
                                        <span t-if="move.payment_id" t-field="move.payment_id.name"/>
                                        <span t-else="">Asiento/Widget</span>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="move.base_amount_paid" 
                                              t-options='{"widget": "monetary", "display_currency": move.currency_id}'/>
                                    </td>
                                    <td class="text-center">
                                        <!-- Calculamos el % efectivo visualmente -->
                                        <t t-if="move.base_amount_paid != 0">
                                            <span t-esc="abs(round((move.amount / move.base_amount_paid) * 100, 2))"/>%
                                        </t>
                                        <t t-else="">
                                            Fixed
                                        </t>
                                    </td>
                                    <td class="text-right font-weight-bold">
                                        <span t-field="move.amount" 
                                              t-options='{"widget": "monetary", "display_currency": move.currency_id}'/>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="bg-white border-top">
                                    <td colspan="4" class="text-right"><strong>Totales:</strong></td>
                                    <td class="text-right">
                                        <strong>
                                            <span t-esc="group['total_base']" 
                                                  t-options='{"widget": "monetary", "display_currency": group["partner"].currency_id}'/>
                                        </strong>
                                    </td>
                                    <td></td>
                                    <td class="text-right">
                                        <strong class="text-success">
                                            <span t-esc="group['total_commission']" 
                                                  t-options='{"widget": "monetary", "display_currency": group["partner"].currency_id}'/>
                                        </strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <!-- Salto de página opcional entre vendedores si la lista es larga -->
                        <!-- <p style="page-break-after:always;"></p> -->
                    </t>

                    <div t-if="not docs" class="alert alert-warning mt-4">
                        No se encontraron comisiones para el rango de fechas seleccionado.
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>